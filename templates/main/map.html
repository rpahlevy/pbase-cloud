{% extends 'layouts/master.html' %}

{% set title = "Map" %}

{% block css %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css" integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA==" crossorigin=""/>
    <style>
        #mymap-wrapper {
            padding-top: 56px;
        }
        @media (min-width: 576px) {
            #mymap-wrapper {
                padding-top: 105px;
            }
        }
    </style>
{% endblock %}

{% block content %}
<div id="mymap-wrapper" class="position-fixed w-100 h-100" style="left:0;bottom:0">
    <div id="mymap" class="w-100 h-100">

    </div>
</div>
{% endblock %}

{% block js %}
    <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js" integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA==" crossorigin=""></script>
    <script>
        var mymap = L.map('mymap').setView([0.68, 122.7], 10);

        L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1Ijoid2lkb3lvIiwiYSI6ImNqcTNmNGh5NjFlMGk0Mm9iamJxdXIxaHUifQ.hxfPpTyy8g60K9baKtbvRw', {
            maxZoom: 18,
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
                '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
            id: 'mapbox.streets'
        }).addTo(mymap);
        var arrIcon = L.icon({
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41],
            iconUrl: "{{ asset('img/marker/marker-icon-green.png') }}",
            shadowUrl: "{{ asset('img/marker/marker-shadow.png') }}"
        });
        var awlrIcon = L.icon({
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41],
            iconUrl: "{{ asset('img/marker/marker-icon-orange.png') }}",
            shadowUrl: "{{ asset('img/marker/marker-shadow.png') }}"
        });
        var lokasi = [
            {% for l in lokasis %}
                {
                    id: {{ l.id }},
                    nama: '{{ l.nama }}',
                    ll: [ {{ l.ll }} ],
                    devices: [
                                {% for d in l.devices %}
                                    '{{ d.sn }}'
                                {% endfor %}
                            ],
                    type:
                        {% if 'AWLR' in l.nama %}
                            'awlr'
                        {% else %}
                            'arr'
                        {% endif %}
                },
            {% endfor %}
        ];
        lokasi.forEach(e => {
            var m = L.marker(e.ll);
            m.bindTooltip(e.nama);
            var icon = e.type == 'arr' ? arrIcon : awlrIcon;
            var jenis = e.type == 'arr' ? 'curahhujan' : 'tma';
            m.setIcon(icon);
            m.bindPopup("<b><a href=/"+ jenis +"/" + e.id + ">" + e.nama + "</a></b>");
            m.addTo(mymap);
        });
    </script>
{% endblock %}
