{% extends 'layouts/mobile/master.html' %}

{% set title = 'Logger' %}

{% block content %}

    <div class="p-3" id="app">

        {% if (user().tenant_id == 0) %}
            <!-- Page Heading -->
            <div class="d-flex align-items-center mb-4">
                <h1 class="h3 mb-0 text-gray-800">{{ title }}</h1>
                <a href="/logger/add" class="btn btn-primary ml-auto" id="btn-create" autofocus>Add new logger</a>
            </div>
        {% endif %}

        <div class="row" v-cloak>
            <div v-for="logger in sortedLoggers" class="col-12 col-sm-6 col-lg-4 mb-3">
                <a class="btn-link text-decoration-none" :href="'/logger/' + logger.sn">
                    <div class="card card-sm h-100 shadow-sm" :class="getBorderType(logger)">
                        <div class="card-body">
                            <div class="d-flex align-items-center font-large mb-3">
                                <div class="flex-fill font-weight-normal" :class="getColorType(logger)">
                                    <span v-if="logger.location_nama">{[{ logger.location_nama }]}</span>
                                    <span v-else class="text-muted">(location not set)</span>
                                </div>
                                <div v-if="logger.content.sampling && !logger.fetching" class="text-muted ml-auto">
                                    {[{ formatSampling(logger.content.sampling) }]}
                                </div>
                                <div v-else-if="logger.fetching" class="text-muted ml-auto">
                                    <i class="fas fa-spin fa-sync"></i>
                                </div>
                            </div>

                            <div class="d-flex align-items-center font-small text-muted">
                                <div>
                                    {[{ logger.sn }]}
                                </div>
                                <div v-if="logger.content.up_since" class="ml-auto">
                                    On {[{ moment.unix(logger.content.up_since).fromNow() }]}
                                </div>
                            </div>

                            <div class="d-flex align-items-center font-small">
                                <div>
                                    <!-- <span v-if="logger.content.tick">
                                        {[{ logger.content.tick }]}
                                    </span>
                                    <span v-if="logger.content.distance">
                                        {[{ logger.content.distance }]}
                                    </span> -->
                                    <span v-if="logger.content.temperature">
                                        <i class="fas fa-thermometer-half"></i>
                                        {[{ logger.content.temperature.toFixed(0) }]}℃
                                    </span>
                                    <span v-if="logger.content.humidity">
                                        • {[{ logger.content.humidity.toFixed(0) }]}%
                                    </span>
                                </div>
                                <div class="ml-auto">
                                    <span v-if="logger.content.altitude">
                                        {[{ logger.content.altitude }]}mdpl
                                    </span>
                                    <span v-if="logger.content.signal_quality">
                                        <i class="fas fa-signal"></i>
                                        {[{ logger.content.signal_quality.toFixed(0) }]}
                                    </span>
                                    <span v-if="logger.content.battery">
                                        <i class="fas fa-battery-three-quarters"></i>
                                        {[{ logger.content.battery.toFixed(0) }]}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </a>
            </div>
        </div>
    </div>

{% endblock %}

{% block js %}
    <script>
        var _app = new Vue({
            el: '#app',
            data: function () {
                return {
                    moment,
                    now: '',
                    loggers: {{ loggers | json_encode | raw }}
                }
            },
            beforeMount: function () {
                this.now = moment(new Date());
                for (var index in this.loggers) {
                    this.fetchRaw(index);
                }
            },
            computed: {
                sortedLoggers: function () {
                    var loggers = this.loggers.slice();
                    loggers.sort((a, b) => {
                        if (!a.content && !b.content) {
                            return 0;
                        }

                        if (!a.content || !a.content.altitude) {
                            return 1;
                        }

                        if (!b.content || !b.content.altitude) {
                            return -1;
                        }

                        if (a.content.altitude > b.content.altitude) {
                            return -1;
                        } else if (a.content.altitude < b.content.altitude) {
                            return 1;
                        }
                        return 0;
                    });
                    // sort done on backend
                    return loggers;
                }
            },
            methods: {
                fetchRaw: function (index) {
                    var logger = this.loggers[index];
                    logger.fetching = true;

                    // if (typeof localStorage['content_'+ logger.sn] != typeof undefined) {
                    //     logger.content = JSON.parse(localStorage['content_'+ logger.sn]);
                    // }

                    $.ajax({
                        url: '/api/logger/'+ logger.sn +'/raw',
                        data: {
                            limit: 1
                        }
                    })
                    .then(res => {
                        if (res.status === 200) {
                            if (res.data.loggers.length > 0) {
                                logger.content = res.data.loggers[0].content;
                                // localStorage['content_'+ logger.sn] = JSON.stringify(res.data.loggers[0].content);
                            }
                        }
                    })
                    .always(() => {
                        logger.fetching = false;
                    });
                },
                getBgSN: function (logger) {
                    if (typeof logger.content === typeof undefined || logger.content.length === 0) {
                        return 'bg-secondary';
                    }

                    if (typeof logger.content.tick !== typeof undefined) {
                        return 'bg-primary';
                    } else if (typeof logger.content.distance !== typeof undefined) {
                        return 'bg-danger';
                    }
                    return 'bg-secondary';
                },
                getColorType: function (logger) {
                    if (typeof logger.content === typeof undefined || logger.content.length === 0) {
                        return '';
                    }

                    if (typeof logger.content.tick !== typeof undefined) {
                        return 'font-weight-bold text-primary';
                    } else if (typeof logger.content.distance !== typeof undefined) {
                        return 'font-weight-bold text-danger';
                    }
                    return '';
                },
                getBorderType: function (logger) {
                    if (typeof logger.content === typeof undefined || logger.content.length === 0) {
                        return '';
                    }

                    if (typeof logger.content.tick !== typeof undefined) {
                        return 'border-arr';
                    } else if (typeof logger.content.distance !== typeof undefined) {
                        return 'border-awlr';
                    }
                    return '';
                },
                formatSampling: function (sampling) {
                    var diffDay = moment.duration(this.now.diff(moment.unix(sampling))).asDays().toFixed(0);
                    var samplingTime = moment.unix(sampling).format('kk:mm');
                    return  diffDay > 0 ? samplingTime +", "+ diffDay +"D" : samplingTime;
                }
            }
        });
    </script>
{% endblock %}
