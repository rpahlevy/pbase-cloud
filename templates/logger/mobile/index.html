{% extends 'layouts/mobile/master.html' %}

{% set title = 'Logger' %}

{% block content %}

    <div class="p-3" id="app">

        {% if (user().tenant_id == 0) %}
            <!-- Page Heading -->
            <div class="d-flex align-items-center mb-4">
                <h1 class="h3 mb-0 text-gray-800">{{ title }}</h1>
                <a href="/logger/add" class="btn btn-primary ml-auto" id="btn-create" autofocus>Add new logger</a>
            </div>
        {% endif %}

        <div v-cloak>
            <div v-for="loggers, tenant_nama in groupedSortedLoggers" class="mb-3">
                <h4>{[{ tenant_nama }]}</h4>
                <div class="row">
                    <div v-for="logger in loggers" class="col-12 col-sm-6 col-lg-4 mb-3">
                        <div class="card card-sm h-100 shadow-sm" :class="getBorderType(logger)">
                            <div class="card-body">
                                <div class="d-flex align-items-center font-large mb-3">
                                    <div class="flex-fill font-weight-normal" :class="getColorType(logger)">
                                        <span v-if="logger.location_nama">{[{ logger.location_nama }]}</span>
                                        <span v-else class="text-muted">(location not set)</span>
                                    </div>
                                    <div v-if="logger.sampling && !logger.fetching" class="text-muted ml-auto">
                                        {[{ formatSampling(logger.sampling) }]}
                                    </div>
                                    <div v-else-if="logger.fetching" class="text-muted ml-auto">
                                        <i class="fas fa-spin fa-sync"></i>
                                    </div>
                                </div>

                                <a class="btn-link text-decoration-none" :href="'/logger/' + logger.sn">
                                    <div class="d-flex align-items-center font-small text-muted">
                                        <div>
                                            {[{ logger.sn }]}
                                        </div>
                                        <div v-if="logger.up_s" class="ml-auto">
                                            On {[{ moment(logger.up_s).fromNow() }]}
                                        </div>
                                    </div>

                                    <div class="d-flex align-items-center font-small">
                                        <div>
                                            <!-- <span v-if="logger.rain">
                                                {[{ logger.rain }]}
                                            </span>
                                            <span v-if="logger.wlev">
                                                {[{ logger.wlev }]}
                                            </span> -->
                                            <span v-if="logger.temp">
                                                <i class="fas fa-thermometer-half"></i>
                                                {[{ logger.temp }]}℃
                                            </span>
                                            <span v-if="logger.humi">
                                                • {[{ logger.humi }]}%
                                            </span>
                                        </div>
                                        <div class="ml-auto">
                                            <span v-if="logger.mdpl">
                                                {[{ logger.mdpl }]}mdpl
                                            </span>
                                            <span v-if="logger.sq">
                                                <i class="fas fa-signal"></i>
                                                {[{ logger.sq }]}
                                            </span>
                                            <span v-if="logger.batt">
                                                <i class="fas fa-battery-three-quarters"></i>
                                                {[{ logger.batt }]}
                                            </span>
                                        </div>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block js %}
    <script>
        const groupBy = key => array =>
          array.reduce((objectsByKeyValue, obj) => {
            const value = obj[key];
            objectsByKeyValue[value] = (objectsByKeyValue[value] || []).concat(obj);
            return objectsByKeyValue;
          }, {});
        const groupByTenantNama = groupBy('tenant_nama');

        var _app = new Vue({
            el: '#app',
            data: function () {
                return {
                    moment,
                    now: '',
                    loggers: {{ loggers | json_encode | raw }}
                }
            },
            beforeMount: function () {
                this.now = moment(new Date());
                // for (var index in this.loggers) {
                //     this.fetchRaw(index);
                // }
            },
            computed: {
                sortedLoggers: function () {
                    var loggers = this.loggers.slice();
                    loggers.sort((a, b) => {
                        if (!a.sampling && !b.sampling) {
                            return 0;
                        }

                        if (!a.sampling) {
                            return 1;
                        }

                        if (!b.sampling) {
                            return -1;
                        }

                        if (!a.mdpl) {
                            return 1;
                        }

                        if (!b.mdpl) {
                            return -1;
                        }

                        // a.mdpl = parseInt(a.mdpl);
                        // b.mdpl = parseInt(b.mdpl);

                        // if (a.mdpl > b.mdpl) {
                        //     return -1;
                        // } else if (a.mdpl < b.mdpl) {
                        //     return 1;
                        // }
                        return 0;
                    });
                    // sort done on backend
                    return loggers;
                },
                groupedSortedLoggers: function () {
                    var gsl = groupByTenantNama(this.sortedLoggers);
                    var gslOrdered = {};
                    Object.keys(gsl).sort().forEach(function(key) {
                      gslOrdered[key] = gsl[key];
                    });
                    return gslOrdered
                }
            },
            methods: {
                fetchRaw: function (index) {
                    var logger = this.loggers[index];
                    logger.fetching = true;

                    // if (typeof localStorage['content_'+ logger.sn] != typeof undefined) {
                    //     logger.content = JSON.parse(localStorage['content_'+ logger.sn]);
                    // }

                    $.ajax({
                        url: '/api/logger/'+ logger.sn +'/raw',
                        data: {
                            limit: 1
                        }
                    })
                    .then(res => {
                        if (res.status === 200) {
                            if (res.data.loggers.length > 0) {
                                logger.content = res.data.loggers[0].content;
                                // localStorage['content_'+ logger.sn] = JSON.stringify(res.data.loggers[0].content);
                            }
                        }
                    })
                    .always(() => {
                        logger.fetching = false;
                    });
                },
                getBgSN: function (logger) {
                    if (!logger.rain && !logger.wlev) {
                        return 'bg-secondary';
                    }

                    if (logger.rain) {
                        return 'bg-primary';
                    } else if (logger.wlev) {
                        return 'bg-danger';
                    }
                    return 'bg-secondary';
                },
                getColorType: function (logger) {
                    if (!logger.rain && !logger.wlev) {
                        return '';
                    }

                    if (logger.rain) {
                        return 'font-weight-bold text-primary';
                    } else if (logger.wlev) {
                        return 'font-weight-bold text-danger';
                    }
                    return '';
                },
                getBorderType: function (logger) {
                    if (!logger.rain && !logger.wlev) {
                        return '';
                    }

                    if (logger.rain) {
                        return 'border-arr';
                    } else if (logger.wlev) {
                        return 'border-awlr';
                    }
                    return '';
                },
                formatSampling: function (sampling) {
                    var diffDay = moment.duration(this.now.diff(moment(sampling))).asDays().toFixed(0);
                    var samplingTime = moment(sampling).format('kk:mm');
                    return  diffDay > 0 ? samplingTime +", "+ diffDay +"D" : samplingTime;
                }
            }
        });
    </script>
{% endblock %}
